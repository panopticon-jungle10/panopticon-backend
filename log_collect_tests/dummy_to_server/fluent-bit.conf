# =====================================================
# Fluent Bit Configuration for Application Logs
# =====================================================
# 
# 목적: 실제 애플리케이션 로그를 tail로 수집하여 Kafka로 전송
# 
# 흐름:
#   1. [INPUT] tail로 로그 파일 읽기
#   2. [PARSER] JSON 파싱
#   3. [FILTER] 로그 레벨별 필터링 및 enrichment
#   4. [OUTPUT] Kafka로 전송
# 
# =====================================================

[SERVICE]
    # Fluent Bit 서비스 설정
    Flush        1
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# =====================================================
# INPUT: 애플리케이션 로그 파일 수집
# =====================================================

[INPUT]
    Name              tail
    Tag               app.logs
    Path              ./logs/application.log
    Parser            json
    Refresh_Interval  1
    Read_from_Head    true
    Skip_Empty_Lines  On
    Buffer_Chunk_Size 32k
    Buffer_Max_Size   256k
    DB                ./logs/fluent-bit-app.db

# =====================================================
# FILTER: 로그 enrichment 및 가공
# =====================================================

# 1. 공통 필드 추가
[FILTER]
    Name    record_modifier
    Match   app.logs
    Record  collector fluent-bit
    Record  source application-log-generator
    Record  environment production

# 2. 로그 레벨별 태그 추가 (선택사항)
# ERROR, FATAL 로그만 별도 처리하고 싶다면:
# [FILTER]
#     Name    rewrite_tag
#     Match   app.logs
#     Rule    $level ^ERROR$ app.error false
#     Rule    $level ^FATAL$ app.fatal false
#     Rule    $level .* app.normal false

# =====================================================
# OUTPUT: Kafka로 전송
# =====================================================

# 방법 1: 모든 로그를 하나의 토픽으로 전송 (추천)
[OUTPUT]
    Name          kafka
    Match         app.logs
    Brokers       localhost:9092
    Topics        application-logs
    Timestamp_Key timestamp
    Retry_Limit   3
    Format        json
    
    # Kafka 성능 최적화
    rdkafka.queue.buffering.max.messages    100000
    rdkafka.queue.buffering.max.kbytes      1048576
    rdkafka.message.send.max.retries        3

# 방법 2: 로그 레벨별 토픽 분리 (선택사항)
# 위의 OUTPUT을 주석처리하고 아래 활성화

# # ERROR/FATAL 로그는 별도 토픽
# [OUTPUT]
#     Name          kafka
#     Match         app.error
#     Brokers       localhost:9092
#     Topics        application-logs-error
#     Format        json

# [OUTPUT]
#     Name          kafka
#     Match         app.fatal
#     Brokers       localhost:9092
#     Topics        application-logs-fatal
#     Format        json

# # 일반 로그
# [OUTPUT]
#     Name          kafka
#     Match         app.normal
#     Brokers       localhost:9092
#     Topics        application-logs-normal
#     Format        json

# =====================================================
# 디버깅용 OUTPUT (선택사항)
# =====================================================

# 콘솔에 로그 출력
[OUTPUT]
    Name   stdout
    Match  app.logs
    Format json_lines

# 파일로 저장 (디버깅용)
# [OUTPUT]
#     Name  file
#     Match app.logs
#     Path  /tmp/fluent-bit-app-output.log
#     Format json_lines
